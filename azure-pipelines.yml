trigger:
- none

pool:
  vmImage: ubuntu-latest   # Recommended over 'default' for consistency and reliability

variables:
  TERRAFORM_DIR: '$(System.DefaultWorkingDirectory)/terraform'

stages:

# ==================== Secret Sanning ====================

  - stage: Secret_Scanning
    displayName: 'Terraform Secret Scanning'
    jobs:
      - job: secretscanning
        displayName: secretscanning
        steps:
          - bash: |
             echo "Installing TruffleHog..."
             curl -sSfL https://github.com/trufflesecurity/trufflehog/releases/download/v3.82.0/trufflehog_3.82.0_linux_amd64.tar.gz | tar -xz
             sudo mv trufflehog /usr/local/bin/trufflehog
             sudo chmod +x /usr/local/bin/trufflehog

             echo "Verifying TruffleHog..."
             trufflehog --version

             echo "Running TruffleHog secrets scan..."
             cd $TERRAFORM_DIR
             trufflehog filesystem . --json --no-verification || true
             # Options:
             # --json             : Structured output (good for logs/artifacts)
             # --no-verification  : Skip entropy check (faster, fewer false negatives)
             # || true            : Don't fail pipeline on findings (remove later to gate)

            displayName: 'TruffleHog Secrets Scan'


          - bash: |
              echo "Installing Gitleaks..."
              # Download and install latest stable version (v8.18.4 as of Jan 2026 - reliable)
              curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar -xz
              sudo mv gitleaks /usr/local/bin/gitleaks
              sudo chmod +x /usr/local/bin/gitleaks

              echo "Verifying Gitleaks installation..."
              gitleaks version

              echo "Running Gitleaks secrets scan..."
              cd $TERRAFORM_DIR
              gitleaks detect --source . --verbose --redact --no-git || true
              # Options explained:
              # --source .     : Scan current directory
              # --verbose      : Detailed output
              # --redact       : Hide actual secret values in logs (security best practice)
              # --no-git       : Scan files only (fast; remove if you want full git history scan)
              # || true        : Don't fail pipeline on findings (remove later to block merges)

            displayName: 'Gitleaks Secrets Scan'

# ==================== TERRAFORM INIT ====================

  - stage: Terraform_Init
    displayName: 'Terraform Init'
    jobs:
      - job: init
        displayName: 'Init'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.9.8'

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(TERRAFORM_DIR)
              backendServiceArm: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              backendAzureRmResourceGroupName: 'rg-statefile'
              backendAzureRmStorageAccountName: 'statefilestorageasad'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
              commandOptions: '-reconfigure'

# ==================== linting ====================

  - stage: Linting_Static_Security
    displayName: 'Terraform Lint & Static Security'
    dependsOn: Terraform_Init
    jobs:
      - job: security_scans
        displayName: 'Run TFLint, TFSec, Checkov'
        steps:
          # Install tools
          - bash: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              pip install checkov
            displayName: 'Install TFLint, TFSec, and Checkov'

          # Run TFLint ... tflint -f compact (optional)
          - bash: |
              cd $TERRAFORM_DIR
              tflint --init
              tflint || true
            displayName: 'Run TFLint'
            continueOnError: true   # Optional: don't fail pipeline on warnings

          # Run TFSec ....tfsec . --format json --out tfsec-results.json (optional)
          - bash: |
              echo "Installing tfsec..."
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

              echo "Running tfsec with SARIF output..."
              cd $TERRAFORM_DIR
              tfsec . --force-all-dirs --format sarif --out tfsec.sarif || true

    # --format sarif : Outputs in SARIF format (standard for code scanning)
    # --out tfsec.sarif : Saves to file
    # || true : Don't fail pipeline on findings

            displayName: 'tfsec IaC Security Scan'
            
          - task: PublishPipelineArtifact@1
            displayName: 'Publish tfsec Results'
            inputs:
              targetPath: '$(TERRAFORM_DIR)/tfsec.sarif'  # Path to the generated file
              artifactName: 'CodeAnalysisLogs'           # Special name for Azure DevOps code scanning integration

          # Run Checkov
          - bash: |
              cd $TERRAFORM_DIR
              checkov -d . --framework terraform --output cli --quiet || true
            displayName: 'Run Checkov'
            continueOnError: true   # Optional: review results without blocking

# ==================== TERRAFORM APPLY ====================

  - stage: Terraform_Plan
    displayName: 'Terraform Plan'
    dependsOn: 
    - Terraform_Init
    - Linting_Static_Security
    jobs:
      - job: plan
        displayName: 'Plan'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.9.8'

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(TERRAFORM_DIR)
              backendServiceArm: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              backendAzureRmResourceGroupName: 'rg-statefile'
              backendAzureRmStorageAccountName: 'statefilestorageasad'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
              commandOptions: '-reconfigure'

          - task: TerraformTask@5
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: $(TERRAFORM_DIR)
              environmentServiceNameAzureRM: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              commandOptions: >-
                -var "admin_username=$(VmAdminUsername)"
                -var "admin_password=$(VmAdminPassword)"

# ==================== IAC Security Compliance ====================

  - stage: Security_Compliance
    displayName: 'Security Compliance'
    dependsOn:
      - Terraform_Plan
    jobs:
      - job: securitycompliance
        displayName: compliance
        steps:

        - bash: |
            echo "Installing Terrascan (latest version)..."
            # Fetch latest Linux x86_64 tar.gz URL and download
            curl -L "$(curl -s https://api.github.com/repos/tenable/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" -o terrascan.tar.gz
            
            # Extract and install
            tar -xzf terrascan.tar.gz
            sudo install terrascan /usr/local/bin/terrascan
            rm terrascan terrascan.tar.gz  # Cleanup

            echo "Verifying Terrascan..."
            terrascan version

            echo "Running Terrascan scan..."
            cd $TERRAFORM_DIR
            terrascan scan -t azure --non-recursive || true
            # -t azure: Focus on Azure policies (your resources)
            # --non-recursive: Faster, scans current dir only
            # || true: Don't fail pipeline (remove later to gate on violations)

          displayName: 'Terrascan IaC Security Scan'

        # - task: SnykSecurityScan@1
        #   displayName: 'Snyk Code Scan'
        #   inputs:
        #     serviceConnectionEndpoint: 'SnykAuthConnection'  # Exact name of your service connection
        #     testType: 'code'                                 # or 'iac' for Terraform
        #     targetFile: 'terraform/'                         # Optional: limit to Terraform folder
        #     severityThreshold: 'high'                        # 'low', 'medium', 'high', 'critical'
        #     failOnIssues: false                              # Set to true to gate pipeline on findings
        #     monitor: true

        - bash: |
            echo "Installing DeepSource CLI..."
            curl https://deepsource.io/cli | sh

            export PATH="$(pwd)/bin:$PATH"

            echo "Verifying installation..."
            deepsource version

            echo "Running DeepSource analysis..."
            cd $TERRAFORM_DIR

            # Try dashboard-connected analysis (requires valid DSN)
            deepsource report --analyzer=static-analysis || echo "Dashboard report failed (check DSN) - running local scan..."

            # Fallback: Local issues list (no DSN needed)
            deepsource issues list || true

          displayName: 'DeepSource Static Analysis'
          env:
            DEEPSOURCE_DSN: $(DeepSourceDSN)

# ==================== FinOps (Check Infracost scan locally)========================

  - stage: FinOps
    displayName: 'FinOps'
    jobs:
    - job: cost_analysis
      steps:
        - bash: |
            echo "Installing OpenInfraQuote..."
            curl -L https://github.com/terrateamio/openinfraquote/releases/latest/download/oiq-linux-amd64 -o oiq
            chmod +x oiq
            sudo mv oiq /usr/local/bin/oiq
            oiq --version  # Optional: Verify installation

            # Install gunzip if needed (ubuntu-latest usually has it, but safe)
            sudo apt-get update && sudo apt-get install -y gzip

            cd $TERRAFORM_DIR

            # Run init if not already done in previous step
            terraform init

            terraform plan -out=tfplan.binary
            terraform show -json tfplan.binary > tfplan.json

            echo "Downloading latest pricesheet..."
            curl -s https://oiq.terrateam.io/prices.csv.gz | gunzip > prices.csv

            echo "Generating cost estimate..."
            oiq match --pricesheet prices.csv tfplan.json | oiq price --region westus2 > cost-estimate.txt

            echo "=== Cost Estimate ==="
            cat cost-estimate.txt
          displayName: 'OpenInfraQuote Cost Estimate'
          
            # If you have Terraform vars/secrets, map them here
          
        - publish: cost-estimate.txt
          artifact: CostEstimate


        # - bash: |
        #     echo "Installing Infracost CLI..."
        #     curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

        #     echo "Running Infracost breakdown..."
        #     cd $TERRAFORM_DIR
        #     infracost breakdown --path . --format json --out-file infracost.json
        #     cat infracost.json | jq '{monthlyCost: .totalMonthlyCost, currency: .currency}'
        #   displayName: 'Infracost Cost Estimate'
        #   env:
        #     INFRACOST_API_KEY: $(infracostApiKey)

        # - task: PublishPipelineArtifact@1
        #   inputs:
        #     targetPath: '$(TERRAFORM_DIR)/infracost.json'
        #     artifactName: 'infracost-report'

# ==================== MANUAL APPROVAL ====================

  - stage: Manual_Approval
    displayName: 'Manual Approval'
    dependsOn:
      - Terraform_Plan
      - Secret_Scanning
      - FinOps
    jobs:
      - job: approval
        displayName: 'Await Approval'
        pool: server
        steps:
          - task: ManualValidation@0
            timeoutInMinutes: 60
            inputs:
              notifyUsers: |
                muhammadasadullah1981@gmail.com
              instructions: |
                All scans completed:
                • Linting
                • Secret scanning (5 tools)
                Review logs and approve to deploy.
              onTimeout: 'reject'

# ==================== TERRAFORM APPLY ====================

  - stage: Terraform_Apply
    displayName: 'Terraform Apply'
    dependsOn:
      - Manual_Approval
    condition: succeeded('Manual_Approval')
    jobs:
      - job: apply
        displayName: 'Apply'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.9.8'

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(TERRAFORM_DIR)
              backendServiceArm: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              backendAzureRmResourceGroupName: 'rg-statefile'
              backendAzureRmStorageAccountName: 'statefilestorageasad'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
              commandOptions: '-reconfigure'

          - task: TerraformTask@5
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: $(TERRAFORM_DIR)
              environmentServiceNameAzureRM: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              commandOptions: >-
                -var "admin_username=$(VmAdminUsername)"
                -var "admin_password=$(VmAdminPassword)"
                -auto-approve