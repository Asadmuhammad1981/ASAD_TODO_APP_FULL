trigger:
- none

pool:
  vmImage: ubuntu-latest   # Recommended over 'default' for consistency and reliability

variables:
  TERRAFORM_DIR: '$(System.DefaultWorkingDirectory)/terraform'

stages:

# ==================== Secret Sanning ====================

  - stage: Secret_Scanning
    displayName: 'Terraform Secret Scanning'
    jobs:
      - job: secretscanning
        displayName: secretscanning
        steps:
          - bash: |
             echo "Installing TruffleHog..."
             curl -sSfL https://github.com/trufflesecurity/trufflehog/releases/download/v3.82.0/trufflehog_3.82.0_linux_amd64.tar.gz | tar -xz
             sudo mv trufflehog /usr/local/bin/trufflehog
             sudo chmod +x /usr/local/bin/trufflehog

             echo "Verifying TruffleHog..."
             trufflehog --version

             echo "Running TruffleHog secrets scan..."
             cd $TERRAFORM_DIR
             trufflehog filesystem . --json --no-verification || true
             # Options:
             # --json             : Structured output (good for logs/artifacts)
             # --no-verification  : Skip entropy check (faster, fewer false negatives)
             # || true            : Don't fail pipeline on findings (remove later to gate)

            displayName: 'TruffleHog Secrets Scan'


          - bash: |
              echo "Installing Gitleaks..."
              # Download and install latest stable version (v8.18.4 as of Jan 2026 - reliable)
              curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar -xz
              sudo mv gitleaks /usr/local/bin/gitleaks
              sudo chmod +x /usr/local/bin/gitleaks

              echo "Verifying Gitleaks installation..."
              gitleaks version

              echo "Running Gitleaks secrets scan..."
              cd $TERRAFORM_DIR
              gitleaks detect --source . --verbose --redact --no-git || true
              # Options explained:
              # --source .     : Scan current directory
              # --verbose      : Detailed output
              # --redact       : Hide actual secret values in logs (security best practice)
              # --no-git       : Scan files only (fast; remove if you want full git history scan)
              # || true        : Don't fail pipeline on findings (remove later to block merges)

            displayName: 'Gitleaks Secrets Scan'

# ==================== TERRAFORM INIT ====================

  - stage: Terraform_Init
    displayName: 'Terraform Init'
    jobs:
      - job: init
        displayName: 'Init'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.9.8'

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(TERRAFORM_DIR)
              backendServiceArm: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              backendAzureRmResourceGroupName: 'rg-statefile'
              backendAzureRmStorageAccountName: 'statefilestorageasad'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
              commandOptions: '-reconfigure'

# ==================== linting ====================

  - stage: Linting_Static_Security
    displayName: 'Terraform Lint & Static Security'
    dependsOn: Terraform_Init
    jobs:
      - job: security_scans
        displayName: 'Run TFLint, TFSec, Checkov'
        steps:
          # Install tools
          - bash: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              pip install checkov
            displayName: 'Install TFLint, TFSec, and Checkov'

          # Run TFLint ... tflint -f compact (optional)
          - bash: |
              cd $TERRAFORM_DIR
              tflint --init
              tflint || true
            displayName: 'Run TFLint'
            continueOnError: true   # Optional: don't fail pipeline on warnings

          # Run TFSec ....tfsec . --format json --out tfsec-results.json (optional)
          - bash: |
              echo "Installing tfsec..."
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

              echo "Running tfsec with SARIF output..."
              cd $TERRAFORM_DIR
              tfsec . --force-all-dirs --format sarif --out tfsec.sarif || true

    # --format sarif : Outputs in SARIF format (standard for code scanning)
    # --out tfsec.sarif : Saves to file
    # || true : Don't fail pipeline on findings

            displayName: 'tfsec IaC Security Scan'
            
          - task: PublishPipelineArtifact@1
            displayName: 'Publish tfsec Results'
            inputs:
              targetPath: '$(TERRAFORM_DIR)/tfsec.sarif'  # Path to the generated file
              artifactName: 'CodeAnalysisLogs'           # Special name for Azure DevOps code scanning integration

          # Run Checkov
          - bash: |
              cd $TERRAFORM_DIR
              checkov -d . --framework terraform --output cli --quiet || true
            displayName: 'Run Checkov'
            continueOnError: true   # Optional: review results without blocking

# ==================== TERRAFORM APPLY ====================

  - stage: Terraform_Plan
    displayName: 'Terraform Plan'
    dependsOn: 
    - Terraform_Init
    - Linting_Static_Security
    jobs:
      - job: plan
        displayName: 'Plan'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.9.8'

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(TERRAFORM_DIR)
              backendServiceArm: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              backendAzureRmResourceGroupName: 'rg-statefile'
              backendAzureRmStorageAccountName: 'statefilestorageasad'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
              commandOptions: '-reconfigure'

          - task: TerraformTask@5
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: $(TERRAFORM_DIR)
              environmentServiceNameAzureRM: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              commandOptions: >-
                -var "admin_username=$(VmAdminUsername)"
                -var "admin_password=$(VmAdminPassword)"

# ==================== IAC Security Compliance ====================

  - stage: Security_Compliance
    displayName: 'Security Compliance'
    dependsOn:
      - Terraform_Plan
    jobs:
      - job: securitycompliance
        displayName: compliance
        steps:

        - bash: |
            echo "Installing Terrascan..."
            curl -L https://github.com/accurics/terrascan/releases/latest/download/terrascan_linux_amd64.tar.gz -o terrascan.tar.gz
            tar -xzf terrascan.tar.gz
            sudo mv terrascan /usr/local/bin/terrascan
            sudo chmod +x /usr/local/bin/terrascan

            echo "Verifying Terrascan version..."
            terrascan version

            echo "Running Terrascan scan..."
            cd $TERRAFORM_DIR
            terrascan scan -t all --non-recursive || true
            # Options explained:
            # -t all               : Scan all supported providers (azure, aws, gcp, etc.)
            # --non-recursive      : Scan only current dir (faster, avoids submodules)
            # || true              : Don't fail pipeline on findings (remove later to gate)

          displayName: 'Terrascan IaC Security Scan'

        - task: SnykSecurityScan@1
          displayName: 'Snyk Code Scan'
          inputs:
            serviceConnection: 'SnykServiceConnection'  # Create a service connection with your API token
            testType: 'code'
            severityThreshold: 'high'
            targetFile: 'terraform/'  # Optional: limit to folder
            failOnIssues: false

        - bash: |
            echo "Installing DeepSource CLI..."
            curl https://deepsource.io/cli | sh

            echo "Adding DeepSource CLI to PATH..."
            export PATH="$(pwd)/bin:$PATH"

            echo "Verifying installation..."
            deepsource --version

            echo "Running DeepSource analysis..."
            deepsource report --analyzer=static-analysis --fail-on-issue
            # Or if you prefer automatic analysis based on .deepsource.toml:
            # deepsource analyze

          displayName: 'DeepSource Static Analysis'
          env:
            DEEPSOURCE_DSN: $(DeepSourceDSN)  # Make sure this secret variable exists

# ==================== FinOps ========================

  - stage: FinOps
    displayName: 'FinOps'
    jobs:
    - job: cost_analysis
      steps:
        - bash: |
            echo "Installing Infracost CLI..."
            curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

            echo "Running Infracost breakdown..."
            cd $TERRAFORM_DIR
            infracost breakdown --path . --format json --out-file infracost.json
            cat infracost.json | jq '{monthlyCost: .totalMonthlyCost, currency: .currency}'
          displayName: 'Infracost Cost Estimate'
          env:
            INFRACOST_API_KEY: $(infracostApiKey)

        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: '$(TERRAFORM_DIR)/infracost.json'
            artifactName: 'infracost-report'

# ==================== MANUAL APPROVAL ====================

  - stage: Manual_Approval
    displayName: 'Manual Approval'
    dependsOn:
      - Terraform_Plan
      - Secret_Scanning
      - FinOps
    jobs:
      - job: approval
        displayName: 'Await Approval'
        pool: server
        steps:
          - task: ManualValidation@0
            timeoutInMinutes: 60
            inputs:
              notifyUsers: |
                muhammadasadullah1981@gmail.com
              instructions: |
                All scans completed:
                • Linting (5 tools)
                • SCA (5 tools)
                • Secret scanning (5 tools)
                • SAST (5 tools)
                • SonarQube quality gate
                Review logs and approve to deploy.
              onTimeout: 'reject'

# ==================== TERRAFORM APPLY ====================

  - stage: Terraform_Apply
    displayName: 'Terraform Apply'
    dependsOn:
      - Manual_Approval
    condition: succeeded('Manual_Approval')
    jobs:
      - job: apply
        displayName: 'Apply'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.9.8'

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(TERRAFORM_DIR)
              backendServiceArm: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              backendAzureRmResourceGroupName: 'rg-statefile'
              backendAzureRmStorageAccountName: 'statefilestorageasad'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
              commandOptions: '-reconfigure'

          - task: TerraformTask@5
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: $(TERRAFORM_DIR)
              environmentServiceNameAzureRM: 'azurerm_asaddevops-ASAD_TODO_APP_FULL'
              commandOptions: >-
                -var "admin_username=$(VmAdminUsername)"
                -var "admin_password=$(VmAdminPassword)"
                -auto-approve